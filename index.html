<!DOCTYPE html>
<html lang="sv">
<head>
  <title>Live GPS från Firebase</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBsiwvyTgZ6DULis2sPhxFGiSY-alC0FM"></script>
  <style>
    html, body, #map {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      border: none;
      overflow: hidden;
      touch-action: manipulation;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    #custom-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 99;
      display: flex;
      gap: 8px;
    }
    #custom-controls button {
      padding: 9px 22px;
      border-radius: 7px;
      border: none;
      background: rgba(40,40,40,0.5);
      color: #fff;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(20,20,20,0.08);
      outline: none;
      transition: background 0.15s, color 0.15s, box-shadow 0.2s;
      backdrop-filter: blur(1px);
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    #custom-controls button:hover {
      background: rgba(70,70,80,0.7);
      color: #fff;
      box-shadow: 0 4px 18px rgba(0,0,0,0.18);
    }
    /* Rund darkmode-knapp nere till höger */
    .darkmode-btn {
      position: absolute;
      right: 24px;
      bottom: 32px;
      z-index: 110;
      width: 54px;
      height: 54px;
      background: rgba(0,0,0,0.5); /* 50% genomskinlig svart */
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.23);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.2s;
      outline: none;
    }
    .darkmode-btn:hover {
      background: rgba(40,40,40,0.7);
      box-shadow: 0 4px 18px rgba(0,0,0,0.26);
    }
    .darkmode-btn svg {
      width: 30px;
      height: 30px;
      fill: #fff;
      display: block;
    }
  </style>
</head>
<body>
  <div id="custom-controls">
    <button onclick="setMapType('roadmap')">Map</button>
    <button onclick="setMapType('satellite')">Sateli</button>
    <button onclick="clearRoutesAndMarkers()">New map</button>
  </div>
  <button class="darkmode-btn" id="darkmode-btn" title="Växla mörkt läge" onclick="toggleDarkMode()">
    <svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 0112.21 3a7 7 0 106.79 9.79z"/></svg>
  </button>
  <div id="map"></div>
  <script>
    // Firebase-konfig
    const firebaseConfig = {
      apiKey: "AIzaSyBBsiwvyTgZ6DULis2sPhxFGiSY-alC0FM",
      authDomain: "maps-94148.firebaseapp.com",
      databaseURL: "https://maps-94148-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "maps-94148",
      storageBucket: "maps-94148.appspot.com",
      messagingSenderId: "677438488330",
      appId: "1:677438488330:web:f0b4cbb057242c5893c4f3"
    };
    firebase.initializeApp(firebaseConfig);

    let map, marker, customMarker = null;
    let drivingRoute = null, walkingRoute = null;
    let drivingClickableLine = null, walkingClickableLine = null;
    let longPressTimer = null;
    let darkModeEnabled = false;

    const darkMapStyle = [
      {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
      {elementType: 'labels.text.stroke', stylers: [{color: '#242f3e'}]},
      {elementType: 'labels.text.fill', stylers: [{color: '#746855'}]},
      {
        featureType: 'road',
        elementType: 'geometry',
        stylers: [{color: '#38414e'}]
      }
    ];

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 15,
        center: { lat: 59.3293, lng: 18.0686 },
        gestureHandling: "greedy",
        fullscreenControl: true,
        mapTypeControl: false,
        zoomControl: false,
        streetViewControl: true,
        rotateControl: true,
        scaleControl: true,
        panControl: true,
        tilt: 0,
        disableDefaultUI: true
      });

      marker = new google.maps.Marker({
        position: { lat: 59.3293, lng: 18.0686 },
        map: map,
        title: "Device1"
      });

      // Firebase-lyssnare
      const ref = firebase.database().ref("live_locations/device1");
      ref.on("value", (snapshot) => {
        const data = snapshot.val();
        if (data && data.lat && data.lon) {
          const pos = { lat: data.lat, lng: data.lon };
          marker.setPosition(pos);
          map.setCenter(pos);
        }
      });

      // Långtryck för att sätta markör
      map.addListener('mousedown', function(event) {
        longPressTimer = setTimeout(function() {
          if (customMarker) customMarker.setMap(null);
          customMarker = new google.maps.Marker({
            position: event.latLng,
            map: map,
            label: "!"
          });
          drawRoutes(marker.getPosition(), event.latLng);
        }, 700); // 700 ms långklick
      });

      map.addListener('mouseup', function(event) {
        clearTimeout(longPressTimer);
      });
      map.addListener('drag', function(event) {
        clearTimeout(longPressTimer);
      });
    }

    function setMapType(type) {
      if (map) {
        map.setMapTypeId(type);
      }
    }

    function clearRoutesAndMarkers() {
      if (drivingRoute) {
        drivingRoute.setMap(null);
        drivingRoute = null;
      }
      if (walkingRoute) {
        walkingRoute.setMap(null);
        walkingRoute = null;
      }
      if (drivingClickableLine) {
        drivingClickableLine.setMap(null);
        drivingClickableLine = null;
      }
      if (walkingClickableLine) {
        walkingClickableLine.setMap(null);
        walkingClickableLine = null;
      }
      if (customMarker) {
        customMarker.setMap(null);
        customMarker = null;
      }
      // Kartan påverkas inte!
    }

    function toggleDarkMode() {
      darkModeEnabled = !darkModeEnabled;
      map.setOptions({styles: darkModeEnabled ? darkMapStyle : null});
    }

    function drawRoutes(start, end) {
      const directionsService = new google.maps.DirectionsService();

      if (drivingRoute) drivingRoute.setMap(null);
      if (walkingRoute) walkingRoute.setMap(null);
      if (drivingClickableLine) drivingClickableLine.setMap(null);
      if (walkingClickableLine) walkingClickableLine.setMap(null);

      // Driving
      directionsService.route({
        origin: start,
        destination: end,
        travelMode: 'DRIVING'
      }, function(result, status) {
        if (status === 'OK') {
          drivingRoute = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
              strokeColor: "#2196f3",
              strokeWeight: 6,
              strokeOpacity: 0.5,
              icons: [{
                icon: { path: 'M 0,-2 0,2', strokeOpacity: 1, scale: 4 },
                offset: '0',
                repeat: '30px'
              }]
            }
          });
          drivingRoute.setDirections(result);
          addClickablePolyline(result.routes[0].overview_path, "#000", "driving");
        }
      });

      // Walking
      directionsService.route({
        origin: start,
        destination: end,
        travelMode: 'WALKING'
      }, function(result, status) {
        if (status === 'OK') {
          walkingRoute = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
              strokeColor: "#539636",
              strokeWeight: 6,
              strokeOpacity: 0.5
            }
          });
          walkingRoute.setDirections(result);
          addClickablePolyline(result.routes[0].overview_path, "#0f0", "walking");
        }
      });
    }

    function addClickablePolyline(path, color, mode) {
      if (mode === "driving" && drivingClickableLine) drivingClickableLine.setMap(null);
      if (mode === "walking" && walkingClickableLine) walkingClickableLine.setMap(null);

      const polyline = new google.maps.Polyline({
        path: path,
        strokeColor: color,
        strokeOpacity: 0.01,
        strokeWeight: 18,
        map: map
      });

      polyline.addListener('click', function() {
        if (mode === "driving") {
          if (walkingRoute) walkingRoute.setMap(null);
          if (walkingClickableLine) walkingClickableLine.setMap(null);
          startNavigation(path, "DRIVING");
        } else if (mode === "walking") {
          if (drivingRoute) drivingRoute.setMap(null);
          if (drivingClickableLine) drivingClickableLine.setMap(null);
          startNavigation(path, "WALKING");
        }
      });

      if (mode === "driving") drivingClickableLine = polyline;
      if (mode === "walking") walkingClickableLine = polyline;
    }

    function startNavigation(path, mode) {
      const start = path[0];
      const end = path[path.length-1];
      window.open(`https://www.google.com/maps/dir/?api=1&origin=${start.lat()},${start.lng()}&destination=${end.lat()},${end.lng()}&travelmode=${mode.toLowerCase()}`, '_blank');
    }

    window.initMap = initMap;
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBsiwvyTgZ6DULis2sPhxFGiSY-alC0FM&callback=initMap"></script>
</body>
</html>
